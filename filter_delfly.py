import bibtexparser
import json

from collections import OrderedDict


papers = dict()

mavlabpapers = {}


parser = bibtexparser.bparser.BibTexParser(common_strings=True)
parser.ignore_nonstandard_types = False
with open('./website/all.bib', encoding="utf8") as bibtex_file:
    bibtex_str = bibtex_file.read()

bib_database = bibtexparser.loads(bibtex_str, parser=parser)

delfly_database = bibtexparser.bibdatabase.BibDatabase()
rest = bibtexparser.bibdatabase.BibDatabase()

print('================================================================')

for b in bib_database.entries:
    #print(b)
    if  not ('author' in b) or not ('title' in b):
        print('ERROR!', b)
        print('------------------------------------------------------------------------')
        continue


    # Paper
    title = b['title']
    authors = b['author']
    delflypaper = False
    if 'keywords' in b:
        title = title + ' ' + b['keywords']

    if 'delfly' in title.lower():
        delflypaper = True
    
    if 'flapping' in title.lower():
        if not ('flapping dynamics' in title.lower()):
            delflypaper = True

    if 'flapper' in title.lower():
        delflypaper = True

    if 'fling' in title.lower():
        delflypaper = True

    if 'karasek' in authors.lower():
        delflypaper = True

    if delflypaper:
        if ('url' in b) and (not ('pdf' in b)):
            b['pdf'] = b['url']
        #if 'abstract' in b:
        #    b.pop('abstract')
        delfly_database.entries.append(b)
    else:
        rest.entries.append(b)

print(mavlabpapers)
    

# dump back
writer = bibtexparser.bwriter.BibTexWriter()
writer.indent = '\t'     # indent entries with 4 spaces instead of one
writer.order_entries_by = 'year'
writer.align_values = True
with open('website/delfly.bib', 'w', encoding='utf8') as bibfile:
    bibfile.write('# AUTOGENERATED\n# \n\n')
    bibfile.write(writer.write(delfly_database).replace('&',r'\&'))


writer = bibtexparser.bwriter.BibTexWriter()
writer.indent = '\t'     # indent entries with 4 spaces instead of one
writer.order_entries_by = 'year'
writer.align_values = True
with open('website/not_delfly.bib', 'w', encoding='utf8') as bibfile:
    bibfile.write('# AUTOGENERATED\n# \n\n')
    bibfile.write(writer.write(rest).replace('&',r'\&'))
    
print('Done')
